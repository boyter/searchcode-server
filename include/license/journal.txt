Going to keep a record of progress and thoughts while doing this in the hopes that I get some sort of useful blog post out of it.

Once of the tickets raised for searchcode-server is the ability to to filter by licence https://github.com/boyter/searchcode-server/issues/96 yes, I am the one who raised the ticket, but it is based on requests from customers. It will also put searchcode server closer to feature parity with Krugle so it seems like a good thing to add.

My first thought was that adding it for say the top 20 most popular licenses shouldn't be the difficult, and its something that I could always expand on later.

So the first thing I needed was to determine the top software licenses in use which thankfully blackduck has already done https://www.blackducksoftware.com/top-open-source-licenses 

Then need to get a copy of them and in a nice format such as JSON. Decided to source them from SPDX since they should be considered the source of truth for this https://spdx.org/licenses/

Wrote a simple script download.py to pull them all down (yes using regex to pull information out of HTML which is BADtm but im not trying to parse it so I am pretty sure he won't come). Sorry SPDX people about crawling your site in a non nice way... 

Added a simple filter to pull back the top 20+ licences so we can test.

Next needed to turn the HTML into JSON. Again an ugly script which calls the beast by using regex to pull information out of HTML. One thing I did notice is that the Fair Source licence was missing. Since I was planning on using searchcode server as a test bed I needed that and added it myself. 

Once again sorry to the SPDX people. If you come to Sydney and ill buy you a beer and apologize for,

1) For creating my own shortname for the Fair Source License without permission
2) For the crappy internet you will experience (Seriously search for Turnbull NBN if you want to see how backwards a country can become, don't want to get political here, but WHY would you ever stop rolling out FTTP and then switch to FTTN!?!?!)

The result is now we have a database of about 20 licences that we can use to try and determine what licence a software project is.

Attempt 1

Made the following assumptions.

A file with a name such as license or copying is likely to exist in the root folder of any project and contain license information. If not have a look inside readme (if it exists). This is the base license for all files inside the project.
Files may have a header which overrides the above.

One thing that I didn't consider is that there may be another license/copying file somewhere deeper inside the file tree. Something to consider for later.

First thought was to just use the vector space search algorith. Its kinda my hammer for every problem. It works reasonably well for a lot of them, is fast enough in most cases and generally gets the job done. Thankfully I had already written one for python a while ago. Don't hate please, I wrote this 10 years ago when I was first learning it and yes its not Pythonic but works. One thing to note is that licenses tend to be of different length. This means that licenses that are closer to each other in length will be matched more closesly using the vector space. This is a cool result.

So the algorithm is,

Find likely candidates for license files.
Compare them to the list of known licenses using the vector space model.
Keep the most likely match.

Then walk through every file in the repository, checking for the special header and when there are no matches try the full header because things like MIT license tend to get included at the top of the file.

The result for searchcode-server

Project License
0.929696395964 Fair Source License v0.9
0.802095284986 Mozilla Public License 2.0 (no copyleft exception)
0.802095284986 Mozilla Public License 2.0

0.925341443302 MIT License /Users/boyter/Documents/Projects/searchcode-server/src/main/resources/public/js/cache.js

Wow. That is a very cool result. It actually worked. It not only picked up that its using the Fair Source Licence it also picked up that that one file is using the MIT license. Lets try it out on some other projects.

Against wordpress,

Project License
0.623430083878 GNU General Public License v2.0 only
0.614318516008 GNU General Public License v1.0 only
0.601642491832 GNU Library General Public License v2 only

Hmmm it did pick up that its probably using GNU GPL v2.0 but it wasn't as confident as it was with the previous. Lets try another one.

minitwit (spark java)

Project License
0.954897366777 MIT License
0.784597744861 Fair Source License v0.9
0.777231345803 Apache License 2.0

Not bad. Its pretty confident that it us under the MIT license.

armory-react

Project License
0.945769202843 BSD 3-clause Clear License
0.937649791859 BSD with attribution
0.927894236317 BSD 2-clause "Simplified" License

Again pretty good. 

Ok. So it looks like we could just pop the top license off and call it a day. This works pretty well with the most common licenses, but why limit ourselves. Lets just do every licese that SPDX has listed? It should work just as well in theory. All we need to do is remove the filter in download.py and rebuild the database and try again.

Trying out on searchcode-server again

Project License
0.929696395964 Fair Source License v0.9
0.813818153434 OCLC Research Public License 2.0
0.804549095187 OSET Public License version 2.1

0.977617793941 BSD Zero Clause License /Users/boyter/Documents/Projects/searchcode-server/include/license/database.json
0.939606278132 Attribution Assurance License /Users/boyter/Documents/Projects/searchcode-server/include/license/database.json
0.908192569643 Open CASCADE Technology Public License /Users/boyter/Documents/Projects/searchcode-server/include/license/database.json
0.902275136399 Adaptive Public License 1.0 /Users/boyter/Documents/Projects/searchcode-server/include/license/database.json
0.93217139424 JSON License /Users/boyter/Documents/Projects/searchcode-server/src/main/resources/public/js/cache.js
0.925341443302 MIT License /Users/boyter/Documents/Projects/searchcode-server/src/main/resources/public/js/cache.js
0.914039614281 feh License /Users/boyter/Documents/Projects/searchcode-server/src/main/resources/public/js/cache.js

Ok so it still picked up fair source as the main project lices which is a good result. However our very cool result of MIT being found in cache.js has gone away. Apparently the JSON license looks like the MIT license to the vector space. What to do. Indeed a diff between them shows that they are almost the same. The differences being right at the start,

MIT  License Copyright (c)               
JSON License Copyright (c) 2002 JSON.org 

and buried in the middle of the JSON license

The Software shall be used for Good, not Evil.

Hah! I remember reading about that a while ago. Something about Google not being able to use it because apparently their motto "Don't be evil" is more a guideline then a rule. https://www.cnet.com/news/dont-be-evil-google-spurns-no-evil-software/

So what we would normally do about now is add keyword weighting to the terms so that in this case MIT makes it rank higher for MIT and JSON for JSON. In fact I started doing just that with keyword it then realised with 328 licenses this is going to be a painful process. Perhaps there is a better way.

Thinking about it what we really want is to find keywords or a collection of multiple keywords that we know to be unique for each license. Then all we need to is check the text for the presense of those keywords. The catch being we need to ensure that they are unique for each license. To do so what I think will work is break the license up into collections of works of length 1-10 and check for unique-ness against the other liceses. The techical term for this is ngrams. 

An example would be,

Lorem ipsum dolor sit amet consetetur sadipscing elitr

bi-grams

[('lorem', 'ipsum'), ('ipsum', 'dolor'), ('dolor', 'sit'), ('sit', 'amet'), ('amet', 'consetetur'), ('consetetur', 'sadipscing'), ('sadipscing', 'elitr')]

tri-grams

[('lorem', 'ipsum', 'dolor'), ('ipsum', 'dolor', 'sit'), ('dolor', 'sit', 'amet'), ('sit', 'amet', 'consetetur'), ('amet', 'consetetur', 'sadipscing'), ('consetetur', 'sadipscing', 'elitr')]

Thankfully this is pretty easy to do in Python so I borrowed an existing bit of code to do it for me, http://locallyoptimal.com/blog/2013/01/20/elegant-n-gram-generation-in-python/

input_list = ['all', 'this', 'happened', 'more', 'or', 'less']

def find_ngrams(input_list, n):
  return zip(*[input_list[i:] for i in range(n)])

For the record I am totally aware that NTLK can also do this but since I don't currently have that installed lets go pure Python. Its a little slower but considering this should rarely run calculation I am not too worried about performance yet.

We can then generate ngrams for each license, then check for its uniqueness in every other one. If no matches found then bazinga we have a gram that uniquely matches the license.

Some simple but stupid code was written parse2.py which does exactly this. Turns out that language is a lot more distinctive for licenses then I first thought,

0BSD 188
AAL 1985
Abstyles 437
Adobe-2006 1234
Adobe-Glyph 1620
ADSL 608
AFL-1.1 555
AFL-1.2 251
AFL-2.0 69
AFL-2.1 67
AFL-3.0 452
Afmparse 959
AGPL-1.0 2212

For the BSD Zero Clause License there are apparently 188 unique ngrams between a length of 2-10 words in it. For the Affero General Public License v1.0 there are a whopping 2212! In fact this seemed like overkill. So I changed the ngrams to start at 5 to 10. This dropped the numbers found by about 25% which seems about right. You would expect the most unique combinations of words to exist at the upper range. One problem I noticed with this is that a lot of the ngrams are based on names that exist within the sample licenses that SPDX has. For example BSD Zero Clause has the name "Rob Landley" which produces a lot of ngrams with this in it as is indeed unique.

However it was taking a long time to process. Not suprising really considering its multiple loop in loops. I tried just searching for ngrams of 4-5 words long, and assuming we didn't find any 0 matches than happy days we can try implementing. Doh! Alas turns out some are not unique enough. The culprits,

Artistic-1.0
BSD-3-Clause
MIT-CMU
MPL-1.1
MPL-2.0-no-copyleft-exception
MPL-2.0

I modified the code to just loop those ones with a more exaustive search to find what worked. Even with ngrams of length 2-10 still there was not enough uniqueness. So I went all out, ngrams from length 2-35.

Artistic-1.0 120
BSD-3-Clause 21

This resolved the issue for Artistic-1.0 and BSD-3-Clause but we still have nothing for the following,

MIT-CMU
MPL-1.1
MPL-2.0-no-copyleft-exception
MPL-2.0

Something is wrong here clearly. Lets look at the text of 

Turns out some of these are particullary troubling. Mozilla Public License 1.1 for example seems to be embedded to an extent in the Netscape Public License v1.1 which of course means nothing about it is unique compared to the other. The others seem to be similar. I tried searching just between both those licences with ngrams of length 2-100 to see if anything would turn up, which of course took a crazy amount of time to process in Python, however the result was that there was nothing that could be used keyword wise to seperate these licenses.

How about a hybrid approach?

If we cannot definitively say using keywords what license the file is, then we can fall back to the vector space to rank based on those without keywords. To do so I flushed the results of the last run into the database file using 7-8 ngrams for everything except Artistic-1.0 and BSD-3-Clause which checked for ngrams with a range of 2-35. The results of this produced the following licenses with their number of unique ngrams,

0BSD 25
AAL 246
Abstyles 54
Adobe-2006 163
Adobe-Glyph 210
ADSL 78
AFL-1.1 77
AFL-1.2 34
AFL-2.0 10
AFL-2.1 9
AFL-3.0 58
Afmparse 125
AGPL-1.0 298
AGPL-3.0 797
Aladdin 1386
AMDPLPA 797
AML 311
AMPAS 163
ANTLR-PD 160
Apache-1.0 100
Apache-1.1 92
Apache-2.0 64
APAFML 92
APL-1.0 6274
APSL-1.0 444
APSL-1.1 323
APSL-1.2 77
APSL-2.0 477
Artistic-1.0-cl8 7
Artistic-1.0-Perl 13
Artistic-1.0 120
Artistic-2.0 1285
Bahyph 223
Barr 96
Beerware 41
BitTorrent-1.0 66
BitTorrent-1.1 814
Borceux 59
BSD-2-Clause-FreeBSD 25
BSD-2-Clause-NetBSD 37
BSD-2-Clause 2
BSD-3-Clause-Attribution 24
BSD-3-Clause-Clear 51
BSD-3-Clause-LBNL 157
BSD-3-Clause-No-Nuclear-License-2014 27
BSD-3-Clause-No-Nuclear-License 14
BSD-3-Clause-No-Nuclear-Warranty 21
BSD-3-Clause 21
BSD-4-Clause-UC 14
BSD-4-Clause 23
BSD-Protection 733
BSD-Source-Code 29
BSL-1.0 127
bzip2-1.0.5 85
bzip2-1.0.6 51
Caldera 210
CATOSL-1.1 1939
CC-BY-1.0 3
CC-BY-2.0 3
CC-BY-2.5 3
CC-BY-3.0 3
CC-BY-4.0 3
CC-BY-NC-1.0 3
CC-BY-NC-2.0 3
CC-BY-NC-2.5 3
CC-BY-NC-3.0 3
CC-BY-NC-4.0 3
CC-BY-NC-ND-1.0 3
CC-BY-NC-ND-2.0 3
CC-BY-NC-ND-2.5 3
CC-BY-NC-ND-3.0 3
CC-BY-NC-ND-4.0 3
CC-BY-NC-SA-1.0 3
CC-BY-NC-SA-2.0 3
CC-BY-NC-SA-2.5 3
CC-BY-NC-SA-3.0 3
CC-BY-NC-SA-4.0 3
CC-BY-ND-1.0 3
CC-BY-ND-2.0 3
CC-BY-ND-2.5 3
CC-BY-ND-3.0 3
CC-BY-ND-4.0 3
CC-BY-SA-1.0 3
CC-BY-SA-2.0 3
CC-BY-SA-2.5 3
CC-BY-SA-3.0 3
CC-BY-SA-4.0 3
CC0-1.0 41
CDDL-1.0 34
CDDL-1.1 93
CECILL-1.0 1563
CECILL-1.1 3351
CECILL-2.0 76
CECILL-2.1 337
CECILL-B 300
CECILL-C 438
ClArtistic 205
CNRI-Jython 318
CNRI-Python-GPL-Compatible 236
CNRI-Python 3
Condor-1.1 627
CPAL-1.0 1037
CPL-1.0 21
CPOL-1.02 1680
Crossword 42
CrystalStacker 159
CUA-OPL-1.0 82
Cube 36
curl 16
D-FSL-1.0 2023
diffmark 11
DOC 617
Dotseqn 37
DSDP 268
dvipdfm 27
ECL-1.0 211
ECL-2.0 163
EFL-1.0 41
EFL-2.0 45
eGenix 424
Entessa 87
EPL-1.0 40
ErlPL-1.1 210
EUDatagrid 278
EUPL-1.0 319
EUPL-1.1 354
Eurosym 115
Fair 39
Frameworx-1.0 1362
FreeImage 120
FSFAP 28
FSFUL 16
FSFULLR 22
FTL 878
GFDL-1.1 380
GFDL-1.2 24
GFDL-1.3 323
Giftware 159
GL2PS 67
Glide 1263
Glulxe 75
gnuplot 163
GPL-1.0 512
GPL-2.0 102
GPL-3.0 827
gSOAP-1.3b 846
HaskellReport 92
HPND 59
IBM-pibs 134
ICU 55
IJG 629
ImageMagick 508
iMatix 520
Imlib2 93
Info-ZIP 406
Intel-ACPI 881
Intel 119
Interbase-1.0 430
IPA 1374
IPL-1.0 135
ISC 32
JasPer-2.0 182
JSON 19
LAL-1.2 766
LAL-1.3 942
Latex2e 57
Leptonica 78
LGPL-2.0 561
LGPL-2.1 813
LGPL-3.0 962
LGPLLR 949
Libpng 573
libtiff 124
LiLiQ-P-1.1 59
LiLiQ-R-1.1 148
LiLiQ-Rplus-1.1 95
LPL-1.0 104
LPL-1.02 123
LPPL-1.0 1154
LPPL-1.1 42
LPPL-1.2 50
LPPL-1.3a 100
LPPL-1.3c 203
MakeIndex 289
MirOS 347
MIT-advertising 36
>>>> MIT-CMU 0
MIT-enna 33
MIT-feh 13
MIT 4
MITNFA 80
Motosoto 367
mpich2 164
MPL-1.0 9
MPL-1.1 0
MPL-2.0-no-copyleft-exception 0
MPL-2.0 0
MS-PL 37
MS-RL 103
MTLL 253
Multics 264
Mup 42
NASA-1.3 1937
Naumen 71
NBPL-1.0 19
NCSA 63
Net-SNMP 412
NetCDF 221
Newsletr 17
NGPL 530
NLOD-1.0 1326
NLPL 33
Nokia 935
NOSL 349
Noweb 190
NPL-1.0 135
NPL-1.1 150
NPOSL-3.0 330
NRL 279
NTP 29
Nunit 34
OCCT-PL 1615
OCLC-2.0 1473
ODbL-1.0 3406
OFL-1.0 228
OFL-1.1 248
OGTSL 271
OLDAP-1.1 8
OLDAP-1.2 16
OLDAP-1.3 22
OLDAP-1.4 35
OLDAP-2.0.1 8
OLDAP-2.0 12
OLDAP-2.1 17
OLDAP-2.2.1 6
OLDAP-2.2.2 6
OLDAP-2.2 17
OLDAP-2.3 6
OLDAP-2.4 15
OLDAP-2.5 18
OLDAP-2.6 14
OLDAP-2.7 9
OLDAP-2.8 23
OML 181
OpenSSL 391
OPL-1.0 461
OSET-PL-2.1 1155
OSL-1.0 143
OSL-1.1 57
OSL-2.0 14
OSL-2.1 9
OSL-3.0 21
PDDL-1.0 2032
PHP-3.0 23
PHP-3.01 24
Plexus 74
PostgreSQL 125
psfrag 52
psutils 237
Python-2.0 394
Qhull 202
QPL-1.0 662
Rdisc 132
RHeCos-1.1 581
RPL-1.1 1065
RPL-1.5 982
RPSL-1.0 2345
RSA-MD 123
RSCPL 1029
Ruby 207
SAX-PD 250
Saxpath 113
SCEA 908
Sendmail 383
SGI-B-1.0 355
SGI-B-1.1 519
SGI-B-2.0 61
SimPL-2.0 436
SISSL-1.2 366
SISSL 269
Sleepycat 123
SMLNJ 61
SMPPL 483
SNIA 325
Spencer-86 57
Spencer-94 88
Spencer-99 113
SPL-1.0 199
SugarCRM-1.1.3 451
SWL 28
TCL 32
TCP-wrappers 68
TMate 124
TORQUE-1.1 415
TOSL 71
Unicode-DFS-2015 78
Unicode-DFS-2016 48
Unicode-TOU 923
Unlicense 123
UPL-1.0 208
Vim 752
VOSTROM 392
VSL-1.0 116
W3C-19980720 220
W3C-20150513 123
W3C 160
Watcom-1.0 823
Wsuipa 82
WTFPL 59
X11 33
Xerox 124
XFree86-1.1 100
xinetd 294
Xnet 33
xpp 138
XSkat 76
YPL-1.0 17
YPL-1.1 16
Zed 34
Zend-2.0 108
Zimbra-1.3 162
Zimbra-1.4 351
zlib-acknowledgement 39
Zlib 2
ZPL-1.1 173
ZPL-2.0 49
ZPL-2.1 81
Fair-Source-0.9 267

Most seem to have over 100 or so unique ngrams which means they will probably work pretty well, and as expected the only exceptions are the MPL licenses which has nothing unique about it compared to every other license. 

I ended up cleaning up the code at this point and improving on the loops so thankfully it took only a few minutes to run. Some of the orginal runs were taking tens of minutes due to some dodgy loops. The resulting file was on the heavy side though at 20 megabytes and crashed most editors when I tried to read it. To resolve this I truncated down to at most 50 unique ngrams per license to see how this worked in the real world. This file weighed in a much more realistic 3 megabytes.

I then created attempt2.py which used the new database using keywords to guess which license the applications had applicable. Firstly I tried it against searchcode-server itself. With the result that the LICENCE file found was indeed the Fair Source License. I then tried it against GCC. Its interesting to note that this resulted in its COPYING file being marked as containing both the GPL-2.0 and LGPL-2.1. At first I thought this might have been a bug in my logic but it seems it was actually correct. The offending ngram used to match was

"street, fifth floor, boston, ma 02110-1301 usa"

Which is supposed to be unique to LGPL-2.1 but included in this case. Since we actually have 813 (but truncated to 50) ngrams for each I figured we might as well when checking see if MOST (70%) of the keywords are there, and if so mark it as a match otherwise ignore. This resutled in the following for GCC

COPYING GPL-2.0
COPYING.LIB GPL-2.0
COPYING.RUNTIME GPL-2.0
COPYING3 GPL-2.0
COPYING3.LIB GPL-2.0

Which is correct. In fact futher tests on various other repositories worked until I hit the react-armory which is under the BSD Clear License. Turns out most of the ngrams generated for it actually involve the project name meaning they are useless. Annoyingly the ngram of length 3 "BSD Clear License" was missed becuase the parser was set to look from 7-8 ngrams. Urgh. 

Thinking about this for a bit, it totally makes sense to look for ngrams from 2-8 even when we are truncating to 50. The smaller ones are going to be high value ones usually and there shouldnt be too many of them. At the very least we should include trigrams (3 length ngrams) since it solves this issue and should work to be unqiue for a lot of licenses. Modifying the parse2.py script to take in a range of numbers defined was easy enough then just let it run and produce the new database to work with and try everything again.

Due to how painful this was getting to test manually I started to build a small test harness which I could eyeball to see if I was getting closer to a result I wanted without regressions. Thankfully it was working perfectly for the tests I was trying.

At this point I tried the same technique across all the files in repositories. Using the previous example of searchcode-server I would have expected that the cache.js file would be marked as MIT license as before. This however was not the case. Because I had the keyword match script se a sliding scale IE it needed a few matches to be considered positive it was missing out on this one.

 I decided at this point to integrate the Vector Space back in. If a file was marked with any license, we would then confirm using the Vector Space and if it was able to have a high degree of confidence over the license that matched then it would be marked as the license. After adding this logic I managed to get the following output,

Bens-MBP:license boyter$ python attempt2.py
0.988840442861 Fair-Source-0.9 /Users/boyter/Documents/Projects/searchcode-server/LICENSE.txt
0.442713859889 MIT /Users/boyter/Documents/Projects/searchcode-server/src/main/resources/public/js/cache.js
0.442713859889 MIT /Users/boyter/Documents/Projects/searchcode-server/target/classes/public/js/cache.js

Exactly what I was looking for. All of the tests I had previously written also passed with this logic. With a simple change to only check the top of the file IE where the header would be by cutting the string down I was able to better the result futher,

Bens-MBP:license boyter$ python attempt2.py
0.988840442861 Fair-Source-0.9 /Users/boyter/Documents/Projects/searchcode-server/LICENSE.txt
0.985719098155 MIT /Users/boyter/Documents/Projects/searchcode-server/src/main/resources/public/js/cache.js
0.985719098155 MIT /Users/boyter/Documents/Projects/searchcode-server/target/classes/public/js/cache.js

That is a seriously cool result. Not only was the code able to identify the licences, it did so with a very percentage of confidence to boot.

I tried running it over a collection of projects I had checked out including GCC, Linux and Wordpress

0.993261478239 BSD-3-Clause-Clear /Users/boyter/Documents/Projects/armory-react/LICENSE
0.999679612780 GPL-3.0 /Users/boyter/Documents/Projects/decodingcaptchas/LICENSE
0.980796066053 OFL-1.1 /Users/boyter/Documents/Projects/decodingcaptchas/lib/font/source-sans-pro/LICENSE
0.999692799354 GPL-3.0 /Users/boyter/Documents/Projects/freemoz/LICENSE
0.999792347852 GPL-2.0 /Users/boyter/Documents/Projects/gcc/COPYING
0.999922926136 LGPL-2.1 /Users/boyter/Documents/Projects/gcc/COPYING.LIB
0.999679612780 GPL-3.0 /Users/boyter/Documents/Projects/gcc/COPYING3
0.999902746595 LGPL-3.0 /Users/boyter/Documents/Projects/gcc/COPYING3.LIB
0.999792347852 GPL-2.0 /Users/boyter/Documents/Projects/gcc/gcc/COPYING
0.999932589474 LGPL-2.1 /Users/boyter/Documents/Projects/gcc/gcc/COPYING.LIB
0.999679612780 GPL-3.0 /Users/boyter/Documents/Projects/gcc/gcc/COPYING3
0.999902746595 LGPL-3.0 /Users/boyter/Documents/Projects/gcc/gcc/COPYING3.LIB
0.858896713823 GPL-2.0 /Users/boyter/Documents/Projects/gcc/gcc/df-core.c
0.999532020106 GFDL-1.3 /Users/boyter/Documents/Projects/gcc/gcc/ada/doc/share/gnu_free_documentation_license.rst
0.948529328513 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/gcc/testsuite/gcc.c-torture/execute/pr20527-1.c
0.994200247145 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/gcc/testsuite/gcc.dg/params/LICENSE
0.999792347852 GPL-2.0 /Users/boyter/Documents/Projects/gcc/include/COPYING
0.999679612780 GPL-3.0 /Users/boyter/Documents/Projects/gcc/include/COPYING3
0.889767272339 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/alloc.c
0.899838703127 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/atomic.c
0.883378984629 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/backtrace.c
0.885232659466 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/btest.c
0.866517942966 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/dwarf.c
0.881126480326 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/elf.c
0.876148037216 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/fileline.c
0.862314849462 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/mmap.c
0.876559695369 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/mmapio.c
0.903997364404 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/nounwind.c
0.880387358104 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/pecoff.c
0.872402129061 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/posix.c
0.881550515104 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/print.c
0.878971997218 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/read.c
0.880857671076 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/simple.c
0.897738871764 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/sort.c
0.890041393843 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/state.c
0.874782494001 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/stest.c
0.897023027383 bzip2-1.0.6 /Users/boyter/Documents/Projects/gcc/libbacktrace/unknown.c
0.879821572348 MITNFA /Users/boyter/Documents/Projects/gcc/libffi/src/mips/ffi.c
0.997055163924 LGPL-2.1 /Users/boyter/Documents/Projects/gcc/libiberty/copying-lib.texi
0.999932589474 LGPL-2.1 /Users/boyter/Documents/Projects/gcc/libiberty/COPYING.LIB
0.899167675944 Intel /Users/boyter/Documents/Projects/gcc/liboffloadmic/runtime/liboffload_error.c
0.889543866358 Intel /Users/boyter/Documents/Projects/gcc/liboffloadmic/runtime/liboffload_msg.c
0.887357763796 Intel /Users/boyter/Documents/Projects/gcc/liboffloadmic/runtime/orsl-lite/lib/orsl-lite.c
0.999932589474 LGPL-2.1 /Users/boyter/Documents/Projects/gcc/libquadmath/COPYING.LIB
0.857337014417 NCSA /Users/boyter/Documents/Projects/gcc/libsanitizer/LICENSE.TXT
1.000000000000 BSL-1.0 /Users/boyter/Documents/Projects/gcc/zlib/contrib/dotzlib/LICENSE_1_0.txt
0.998470560414 GPL-2.0 /Users/boyter/Documents/Projects/linux/COPYING
0.999831352903 LGPL-2.0 /Users/boyter/Documents/Projects/linux/arch/sparc/lib/COPYING.LIB
0.997101938433 GPL-2.0 /Users/boyter/Documents/Projects/linux/Documentation/networking/LICENSE.qlcnic
0.997101938433 GPL-2.0 /Users/boyter/Documents/Projects/linux/Documentation/networking/LICENSE.qlge
0.997004626197 GPL-2.0 /Users/boyter/Documents/Projects/linux/Documentation/scsi/LICENSE.qla2xxx
0.997004626197 GPL-2.0 /Users/boyter/Documents/Projects/linux/Documentation/scsi/LICENSE.qla4xxx
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c3xxx/adf_c3xxx_hw_data.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c3xxx/adf_drv.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c3xxxvf/adf_c3xxxvf_hw_data.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c3xxxvf/adf_drv.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c62x/adf_c62x_hw_data.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c62x/adf_drv.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c62xvf/adf_c62xvf_hw_data.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_c62xvf/adf_drv.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_accel_engine.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_admin.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_aer.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_cfg.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_ctl_drv.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_dev_mgr.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_hw_arbiter.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_init.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_isr.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_pf2vf_msg.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_sriov.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_transport.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_transport_debug.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_vf2pf_msg.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/adf_vf_isr.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/qat_algs.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/qat_asym_algs.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/qat_crypto.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/qat_hal.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_common/qat_uclo.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_dh895xcc/adf_dh895xcc_hw_data.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_dh895xcc/adf_drv.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_dh895xccvf/adf_dh895xccvf_hw_data.c
0.900564102581 Intel /Users/boyter/Documents/Projects/linux/drivers/crypto/qat/qat_dh895xccvf/adf_drv.c
0.998958351972 GPL-2.0 /Users/boyter/Documents/Projects/linux/drivers/staging/rtl8192e/license
0.999594583136 GPL-2.0 /Users/boyter/Documents/Projects/linux/drivers/staging/rtl8192u/copying
0.999792347852 GPL-2.0 /Users/boyter/Documents/Projects/linux/tools/usb/usbip/COPYING
0.952930843666 Sleepycat /Users/boyter/Documents/Projects/pathos/dill-0.2.1/LICENSE
0.952930843666 Sleepycat /Users/boyter/Documents/Projects/pathos/pathos-master/LICENSE
0.952930843666 Sleepycat /Users/boyter/Documents/Projects/pathos/pox-0.2/LICENSE
0.987991559152 MIT /Users/boyter/Documents/Projects/phonecat/LICENSE
1.000000000000 Apache-2.0 /Users/boyter/Documents/Projects/python-goose/LICENSE.txt
1.000000000000 Apache-2.0 /Users/boyter/Documents/Projects/searchcode/searchcode/searchcode/static/admin/fonts/LICENSE.txt
0.987991559152 MIT /Users/boyter/Documents/Projects/searchcode/searchcode/searchcode/static/admin/js/vendor/xregexp/LICENSE-XREGEXP.txt
0.988840442861 Fair-Source-0.9 /Users/boyter/Documents/Projects/searchcode-server/LICENSE.txt
0.985719098155 MIT /Users/boyter/Documents/Projects/searchcode-server/src/main/resources/public/js/cache.js
0.985719098155 MIT /Users/boyter/Documents/Projects/searchcode-server/target/classes/public/js/cache.js
0.999268167835 LGPL-2.1 /Users/boyter/Documents/Projects/seo/vendor/videlalvaro/php-amqplib/LICENSE
0.999692799354 GPL-3.0 /Users/boyter/Documents/Projects/SingleBugs/LICENSE
0.999692799354 GPL-3.0 /Users/boyter/Documents/Projects/testing/LICENSE
0.997865652460 GPL-2.0 /Users/boyter/Documents/Projects/wordpress/license.txt
0.999792346238 GPL-2.0 /Users/boyter/Documents/Projects/wordpress/wp-content/themes/twentyfourteen/genericons/LICENSE.txt
0.999792346238 GPL-2.0 /Users/boyter/Documents/Projects/wordpress/wp-content/themes/twentythirteen/fonts/LICENSE.txt
0.999792346238 GPL-2.0 /Users/boyter/Documents/Projects/wordpress/wp-includes/js/plupload/license.txt
0.999932589474 LGPL-2.1 /Users/boyter/Documents/Projects/wordpress/wp-includes/js/tinymce/license.txt

Rather cool. Lots of licenses identified with quite a lot of confidence.

There is however one issue I am overlooking, and frankly I am not 100% how this is meant to work out. Take for example a project which includes another project. What license should be displayed for the files that are in the latter? It seems that generally the files should only be included if the license is compatible, but that they fall under the top level license in this case. However it would be very nice to see this information. While the license file itself will be marked as being some other license, knowing that the files under it fall under that license would be very helpful.

The last issue is what to do when there are multiple license files in the root directory. GCC is an example of this and it has 4 licenses defined in the root. The idea being you take which one is most applicable to your project.

0.999792347852 GPL-2.0 /gcc/COPYING
0.999922926136 LGPL-2.1 /gcc/COPYING.LIB
0.99967961278 GPL-3.0 /gcc/COPYING3
0.999902746595 LGPL-3.0 /gcc/COPYING3.LIB

Looking at the SPDX specification the rule is to define them as being under all. I this case using the following,

```Representing Multiple Licenses

Multiple licenses can be represented using a SPDX license expression as defined in Appendix IV.  A set of licenses must be enclosed in parentheses (this is a convention for SPDX expressions).  As further described there:

When there is a choice between licenses ("disjunctive license"), they should be separated with "OR". If presented with a choice between two or more licenses, use the disjunctive binary "OR" operator to construct a new license expression.
Similarly when multiple licenses need to be simultaneously applied ("conjunctive license"), they should be separated with "AND". If required to simultaneously comply with two or more licenses, use the conjunctive binary "AND" operator to construct a new license expression.
In some cases, a set of license terms apply except under special circumstances, in this case, use the "WITH" operator followed by one of the recognized exception identifiers.
Sometimes a set of license terms apply except under special circumstances. In this case, use the binary "WITH" operator to construct a new license expression to represent the special exception situation.
Examples:

SPDX-License-Identifier: (GPL-2.0 OR MIT)
SPDX-License-Identifier: (LGPL-2.1 AND BSD-2-CLAUSE)
SPDX-License-Identifier: (GPL-2.0+ WITH Bison-exception-2.2)```

Taken from https://spdx.org/spdx-specification-21-web-version Appendix V: Using SPDX short identifiers in Source Files
 
Fair enough. We then need to write one last version of our license guesser which will use everything done above BUT support multiple licenses and look for license files inside root directories and make anything below it as belonging to that one, unless of course there is another license file or it is over-ridden by the header. We are not trying to keep track of the above WITH AND logic as I just want to mark each file with the potential license. As such just marking it so is good enough.

For this I simply copied the existing attempt2.py and created attempt3.py which should hopefully be the last version for this. What we now need to do is walk the tree, and every time we encounter a license file, keep track of the license that the file should be under, and for any file that is a child of that license mark as such. When we leave the directory then we pop the license off.

Thankfully this was a very easy change to implement. I used a project which I knew to already have some mixed licenses and ran over it.

>>>>>>> /Users/boyter/Documents/Projects/decodingcaptchas//LICENSE GPL-3.0
>>>>>>> /Users/boyter/Documents/Projects/decodingcaptchas//LICENSE GPL-3.0
>>>>>>> /Users/boyter/Documents/Projects/decodingcaptchas//LICENSE GPL-2.0
>>>>>>> /Users/boyter/Documents/Projects/decodingcaptchas//LICENSE GPL-2.0
/Users/boyter/Documents/Projects/decodingcaptchas//Gruntfile.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/crack.py GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/crack_test.py GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/geticons.py GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/step1.py GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/step2.py GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/step3.py GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/step4.py GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/code/style.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/reveal.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/print/paper.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/print/pdf.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/beige.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/black.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/blood.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/league.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/moon.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/night.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/serif.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/simple.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/sky.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/solarized.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/css/theme/white.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/js/reveal.js GPL-2.0 GPL-3.0
>>>>>>> /Users/boyter/Documents/Projects/decodingcaptchas/lib/LICENSE Fair-Source-0.9
/Users/boyter/Documents/Projects/decodingcaptchas/lib/css/zenburn.css Fair-Source-0.9 GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/lib/font/league-gothic/league-gothic.css Fair-Source-0.9 GPL-2.0 GPL-3.0
>>>>>>> /Users/boyter/Documents/Projects/decodingcaptchas/lib/font/source-sans-pro/LICENSE OFL-1.1
>>>>>>> /Users/boyter/Documents/Projects/decodingcaptchas/lib/font/source-sans-pro/LICENSE OFL-1.1
/Users/boyter/Documents/Projects/decodingcaptchas/lib/font/source-sans-pro/source-sans-pro.css Fair-Source-0.9 GPL-2.0 GPL-3.0 OFL-1.1
/Users/boyter/Documents/Projects/decodingcaptchas/lib/js/classList.js Fair-Source-0.9 GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/lib/js/head.min.js Fair-Source-0.9 GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/lib/js/html5shiv.js Fair-Source-0.9 GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/highlight/highlight.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/leap/leap.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/markdown/markdown.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/markdown/marked.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/math/math.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/multiplex/client.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/multiplex/index.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/multiplex/master.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/notes/notes.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/notes-server/client.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/notes-server/index.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/print-pdf/print-pdf.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/remotes/remotes.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/search/search.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/plugin/zoom-js/zoom.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/test/qunit-1.12.0.css GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/test/qunit-1.12.0.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/test/test-markdown-element-attributes.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/test/test-markdown-slide-attributes.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/test/test-markdown.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/test/test-pdf.js GPL-2.0 GPL-3.0
/Users/boyter/Documents/Projects/decodingcaptchas/test/test.js GPL-2.0 GPL-3.0

What this shows is each file along with each license that the program belives it to belong to. Files prefixed with >>>>>>> indicate a license file which changes the licenses of the files below it.

The root of the project is dual licensed under GPL-2.0 and GPL-3.0 which makes everything have at least those two licenses. There are however also some fonts under the SIL Open Font License 1.1 which were also picked up. To make things a little harder I added the Fair Souce license under the lib directory to see if this would be reflected correctly.

Pretty happy with the result. I ran it against GCC and the Linux Kernel. The output for both are too large to post on this blog but you can view the GCC one as a gist https://gist.github.com/boyter/ee534011cf512ba7e2992ecdef87523c 

Well that about covers that. Everything seems to work as I would exepct and it would be reasonably easy at this point to take the code and produce a full blown SPDX parser. I will leave that as an excercise for the reader (unless it turns out I need one at a later date).


























